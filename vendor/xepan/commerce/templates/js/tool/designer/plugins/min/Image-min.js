xShop_Image_Editor=function(e,i){var t=this;this.parent=e,this.designer_tool=i.designer_tool,this.current_image_component=void 0;var n=i.designer_tool.options.base_url,s=n;this.element=$('<div id="xshop-designer-image-editor" style="display:block" class="xshop-options-editor"></div>').appendTo(this.parent),this.row1=$('<div class="atk-row xshop-designer-tool-editing-helper image" style="display:block;margin:0;"> </div>').appendTo(this.element),this.image_x_label=$('<div class="atk-move-left"><label for="xshop-designer-image-positionx">x: </label></div>').appendTo(this.row1),this.image_x=$('<input name="x" id="xshop-designer-image-positionx" class="xshop-designer-image-inputx" style="width:45px !important" />').appendTo(this.image_x_label),$(this.image_x).change(function(){t.current_image_component.options.x=$(this).val(),$(".xshop-designer-tool").xepan_xshopdesigner("check"),t.current_image_component.render(t.designer_tool)}),this.image_y_label=$('<div class="atk-move-left"><label for="xshop-designer-image-positiony">y: </label></div>').appendTo(this.row1),this.image_y=$('<input name="y" id="xshop-designer-image-positiony" class="xshop-designer-image-inputy" style="width:45px !important" />').appendTo(this.image_y_label),$(this.image_y).change(function(){t.current_image_component.options.y=$(this).val(),$(".xshop-designer-tool").xepan_xshopdesigner("check"),t.current_image_component.render(t.designer_tool)}),this.image_width_label=$('<div class="atk-move-left"><label for="xshop-designer-image-width">W: </label></div>').appendTo(this.row1),this.image_width=$('<input name="W" title="width" id="xshop-designer-image-width" class="xshop-designer-image-width" style="width:45px !important" />').appendTo(this.image_width_label),$(this.image_width).change(function(){t.current_image_component.options.width=t.current_image_component.designer_tool.screen2option($(this).val()),$(".xshop-designer-tool").xepan_xshopdesigner("check"),t.current_image_component.render(t.designer_tool)}),this.image_height_label=$('<div class="atk-move-left"><label for="xshop-designer-image-height">H: </label></div>').appendTo(this.row1),this.image_height=$('<input name="H" title="height" id="xshop-designer-image-height" class="xshop-designer-image-height" style="width:45px !important" />').appendTo(this.image_height_label),$(this.image_height).change(function(){t.current_image_component.options.height=t.current_image_component.designer_tool.screen2option($(this).val()),$(".xshop-designer-tool").xepan_xshopdesigner("check"),t.current_image_component.render(t.designer_tool)}),this.editor_close_btn=$('<div class="xshop-designer-tool-editor-option-close"><i class="atk-box-small pull-right glyphicon glyphicon-remove"></i></div>').appendTo(this.element),this.image_button_set=$('<div class="btn-group" role="group"></div>').appendTo(this.element),this.text_input=this.image_edit=$('<div class="btn xshop-designer-image-edit-btn"><i class="icon-picture atk-size-tera"></i><br/><span class="atk-size-micro">Insert</span></div>').appendTo(this.image_button_set),this.image_crop_resize=$('<div class="btn xshop-designer-image-crop-btn"><i class="icon-crop atk-size-tera"></i><br/><span class="atk-size-micro">Crop</span></div>').appendTo(this.image_button_set),this.image_mask_apply=$('<div class="btn xshop-designer-image-mask-apply-btn"><i class="glyphicon glyphicon-picture atk-size-tera"></i><br/><span class="atk-size-micro">Apply Mask</span></div>').appendTo(this.image_button_set),this.image_mask_edit=$('<div class="btn xshop-designer-image-mask-edit-btn"><i class="glyphicon glyphicon-picture atk-size-tera"></i><br/><span class="atk-size-micro">Edit Mask</span></div>').appendTo(this.image_button_set),this.image_lock=$('<div class="btn xshop-designer-image-lock-btn"><i class="icon-lock atk-size-tera"></i><br/><span class="atk-size-micro">Lock</span></div>').appendTo(this.image_button_set),this.image_up_down=$('<div class="btn xshop-designer-image-up-down-btn"></div>').appendTo(this.image_button_set),this.image_up=$('<div class="xshop-designer-image-up-btn icon-angle-circled-up atk-size-mega xshop-designer-image-up-btn" title="Bring to Front" ></div>').appendTo(this.image_up_down),this.image_down=$('<div class="xshop-designer-image-down-btn icon-angle-circled-down atk-size-mega xshop-designer-image-up-btn" title="Send to Back" ></div>').appendTo(this.image_up_down),this.image_remove=$('<div class="btn xshop-designer-image-remove-btn"><i class="icon-trash atk-size-tera"></i><br/><span class="atk-size-micro">Remove</span></div>').appendTo(this.image_button_set),$(this.editor_close_btn).click(function(e){t.element.hide()}),this.image_mask_apply.click(function(e){t.current_image_component.options.apply_mask=!0,$(t.current_image_component.element).find("img[is_mask_image=1]").hide(),t.current_image_component.render(t.designer_tool)}),this.image_mask_edit.click(function(e){t.current_image_component.options.apply_mask=!1,$(t.current_image_component.element).find("img[is_mask_image=1]").show(),t.current_image_component.render(t.designer_tool)}),this.image_remove.click(function(){dt=t.current_image_component.designer_tool,$.each(dt.pages_and_layouts[dt.current_page][dt.current_layout].components,function(e,i){i===dt.current_selected_component&&($(dt.current_selected_component.element).remove(),dt.pages_and_layouts[dt.current_page][dt.current_layout].components.splice(e,1),dt.canvasObj.getActiveObject().remove(),dt.current_selected_component=null,dt.option_panel.hide())})}),this.image_lock.click(function(){current_image=$(t.current_image_component.element),current_image.hasClass("xepan-designer-lock-component")?($(".xepan-designer-image-unlock-btn").remove(),current_image.removeClass("xepan-designer-lock-component")):(current_image.addClass("xepan-designer-lock-component"),unlock=$('<div class="xepan-designer-image-unlock-btn atk-label atk-size-mega atk-swatch-blue" title="Click here to unlock the image"><i class="icon-lock-open"></i></div>').appendTo(current_image),unlock.click(function(){$(".xepan-designer-image-unlock-btn").remove(),current_image.removeClass("xepan-designer-lock-component")}))}),this.image_up.click(function(){current_image=$(t.current_image_component.element),current_zindex=current_image.css("z-index"),"auto"==current_zindex&&(current_zindex=0),current_image.css("z-index",parseInt(current_zindex)+1),t.current_image_component.options.zindex=current_image.css("z-index"),$("div.xshop-designer-image-down-btn").hasClass("xepan-designer-button-disable")&&$("div.xshop-designer-image-down-btn").removeClass("xepan-designer-button-disable")}),this.image_down.click(function(){current_image=$(t.current_image_component.element),current_zindex=current_image.css("z-index"),"auto"==current_zindex||parseInt(current_zindex)-1<0?current_zindex=0:current_zindex=parseInt(current_zindex)-1,current_image.css("z-index",current_zindex),t.current_image_component.options.zindex=current_zindex,0==current_zindex&&$("div.xshop-designer-image-down-btn").addClass("xepan-designer-button-disable")}),this.image_mask_apply.hide(),this.image_mask_edit.hide(),this.image_crop_resize.click(function(e){e.preventDefault(),e.stopPropagation(),url=t.current_image_component.options.url,o=t.current_image_component.options,xx=$('<div class="xshop-designer-image-crop"></div>').appendTo(t.element),crop_image=$('<img class="xshop-img" src='+url+"></img>").appendTo(xx),x=$("<div></div>").appendTo(crop_image),y=$("<div></div>").appendTo(crop_image),width=$("<div></div>").appendTo(crop_image),height=$("<div></div>").appendTo(crop_image),xx.dialog({minWidth:800,modal:!0,open:function(e,i){$(crop_image).cropper({aspectRatio:!1,multiple:!0,data:{x:1==o.crop?o.crop_x:0,y:1==o.crop?o.crop_y:0,width:1==o.crop?o.crop_width:$(crop_image).width(),height:1==o.crop?o.crop_height:$(crop_image).height()},done:function(e){$(x).val(Math.round(e.x)),$(y).val(Math.round(e.y)),$(width).val(Math.round(e.width)),$(height).val(Math.round(e.height))}});var t=$.find(".ui-dialog-titlebar")},close:function(e,i){console.log("crop window close")},buttons:{Continue:function(){t.current_image_component.options.crop=!0,t.current_image_component.options.crop_x=$(x).val(),t.current_image_component.options.crop_y=$(y).val(),t.current_image_component.options.crop_width=$(width).val(),t.current_image_component.options.crop_height=$(height).val(),t.current_image_component.render(t.designer_tool,!0),$(this).dialog("close")}}})}),this.image_edit.click(function(e){options={modal:!0,height:500},frame=$.univ().frameURL("Manage Your Images","?page=xepan_commerce_designer_itemimages",options).addClass("xepan-designer-image-dialog")}),this.setImageComponent=function(e){this.current_image_component=e}},Image_Component=function(e){this.parent=void 0,this.designer_tool=void 0,this.canvas=void 0,this.element=void 0,this.editor=void 0,this.xhr=void 0,this.mask=void 0,this.options={x:0,y:0,width:!1,height:!1,url:"templates/images/logo.png",crop_x:!1,crop_y:!1,crop_width:!1,crop_height:!1,crop:!1,replace_image:!1,rotation_angle:0,locked:!1,alignment_left:!1,alignment_center:!1,alignment_right:!1,movable:!0,colorable:!0,editable:!0,default_url:"templates/images/logo.png",zindex:0,resizable:!0,auto_fit:!1,frontside:!0,backside:!1,multiline:!1,type:"Image",is_mask_image:!1,mask_added:!1,apply_mask:!1,mask_options:{},base_url:void 0,page_url:void 0,rotation_angle:0},this.init=function(e,i,o){this.designer_tool=e,this.canvas=i,void 0!==o&&(this.editor=o)},this.initExisting=function(e){},this.addImage=function(e,i){var o=this,t=new Image_Component;return t.init(o.designer_tool,o.canvas,o.editor),t.options.x=0,t.options.y=0,t.options.url=e,i===!0&&(t.options.is_mask_image=!0),o.designer_tool.pages_and_layouts[o.designer_tool.current_page][o.designer_tool.current_layout].components.push(t),t.render(o.designer_tool,!0),t},this.isMaskOptionsAdded=function(){var e=this;return e.options.mask_added&&e.options.mask_options.url},this.isMaskAppended=function(){var e=this;return e.element.find("img[is_mask_image=1]").length},this.updateMask=function(){var e=this;if(e.isMaskOptionsAdded()&&!e.isMaskAppended()){var i=new Image_Component;return i.init(e.designer_tool,e.canvas,e.editor),i.options.url=e.options.mask_options.url,i.options=e.options.mask_options,i.options.is_mask_image=!0,i.options.x=0,i.options.y=0,i.render(e.designer_tool,!0),e.mask=i,e.options.mask_added=!0,$(i.element).appendTo(e.element),i.render(e.designer_tool),$(i.element).draggable("option","containment",e.element),i}return e.mask.render(e.designer_tool),i},this.renderTool=function(e){var i=this;this.parent=e,i.options.base_url=i.designer_tool.options.base_url,i.options.page_url=i.designer_tool.options.base_url,tool_btn=$('<div class="btn btn-deault xshop-designer-image-toolbtn "><i class="glyphicon glyphicon-picture"></i><br>Image</div>').appendTo(e.find(".xshop-designer-tool-topbar-buttonset")).data("tool",i),this.editor=new xShop_Image_Editor(e.find(".xshop-designer-tool-topbar-options"),i),tool_btn.click(function(e){void 0!=i.designer_tool.current_selected_component&&"Image"!=i.designer_tool.current_selected_component.options.type&&(i.designer_tool.current_selected_component=void 0),options={modal:!0,height:500},frame=$.univ().frameURL("Manage Your Images","?page=xepan_commerce_designer_itemimages",options).addClass("xepan-designer-image-dialog")})},this.render=function(e,i){var o=this;e&&(o.designer_tool=e),void 0==o.options.base_url&&(o.options.base_url=o.designer_tool.options.base_url,o.options.page_url=o.designer_tool.options.base_url),this.element&&o.designer_tool.canvasObj.getActiveObject().remove();var t=o.designer_tool.canvasObj,n=new fabric.Image.fromURL(o.options.url,function(e){e.set({left:o.options.x*o.designer_tool._getZoom(),top:o.options.y*o.designer_tool._getZoom(),angle:o.options.rotation_angle}),e.on("selected",function(i){$(".ui-selected").removeClass("ui-selected"),$(this).addClass("ui-selected"),$(".xshop-options-editor").hide(),o.editor.element.show(),o.designer_tool.option_panel.show("fast",function(e){0==o.options.zindex?$("div.xshop-designer-image-down-btn").addClass("xepan-designer-button-disable"):$("div.xshop-designer-image-down-btn").removeClass("xepan-designer-button-disable")}),o.designer_tool.options.designer_mode?(o.designer_tool.freelancer_panel.FreeLancerComponentOptions.element.show(),o.designer_tool.freelancer_panel.setComponent($(this).data("component"))):$(".xshop-designer-tool-editing-helper.image").hide(),o.designer_tool.option_panel.fadeIn(500),o.designer_tool.option_panel.css("z-index",70),o.designer_tool.option_panel.addClass("xshop-text-options"),o.designer_tool.option_panel.offset({top:o.designer_tool.canvasObj._offset.top+e.top-o.designer_tool.option_panel.height(),left:o.designer_tool.canvasObj._offset.left+e.left}),o.designer_tool.options.designer_mode&&(o.editor.image_x.val(o.options.x),o.editor.image_y.val(o.options.y),o.editor.image_width.val(o.options.width),o.editor.image_height.val(o.options.height)),o.editor.setImageComponent(o),i.stopPropagation?i.stopPropagation():i.cancelBubble=!0}),o.element=e,o.element.component=o,o.designer_tool.canvasObj.renderAll(),t.add(e),o.options.width?(e.width=o.options.width*o.designer_tool._getZoom(),e.height=o.options.height*o.designer_tool._getZoom()):(t.getWidth()<t.getHeight()?e.scaleToWidth(.75*t.getWidth()):e.scaleToHeight(.75*t.getHeight()),o.options.width=e.width/o.designer_tool._getZoom(),o.options.height=e.height/o.designer_tool._getZoom()),t.renderAll()});return;void 0==this.element?(this.element=$('<div style="position:absolute" class="xshop-designer-component"><span class="xepan-designer-dropped-image"><img is_mask_image="'+(1==o.options.is_mask_image?"1":"0")+'"></img></span></div>').appendTo(this.canvas),this.element.draggable({containment:o.designer_tool.safe_zone,smartguides:".xshop-designer-component",tolerance:5,stop:function(e,i){var t=i.position;o.options.x=o.designer_tool.screen2option(t.left),o.options.y=o.designer_tool.screen2option(t.top),o.editor.image_x.val(t.left),o.editor.image_y.val(t.top)}}).resizable({containment:"parent",aspectRatio:!0,autoHide:!0,handles:"se",stop:function(e,i){o.options.width=o.designer_tool.screen2option(i.size.width),o.options.height=o.designer_tool.screen2option(i.size.height),o.editor.image_width.val(i.size.width),o.editor.image_height.val(i.size.height),o.render(o.designer_tool)}}),$(this.element).data("component",this),o.options.movable||o.element.draggable("disable"),o.options.colorable||o.editor.text_color_picker.next("button").hide(),o.options.editable||o.editor.text_input.hide(),o.options.resizable||o.element.resizable("disable"),$(this.element).click(function(e){$(".ui-selected").removeClass("ui-selected"),$(this).addClass("ui-selected"),$(".xshop-options-editor").hide(),o.editor.element.show(),o.designer_tool.option_panel.show("fast",function(e){1==o.options.mask_added&&void 0!=o.options.mask_options.url?($("div.xshop-designer-image-mask-apply-btn").show(),$("div.xshop-designer-image-mask-edit-btn").show()):($("div.xshop-designer-image-mask-apply-btn").hide(),$("div.xshop-designer-image-mask-edit-btn").hide()),1==o.options.mask_added||o.options.is_mask_image?$("div.xshop-designer-image-mask-btn").hide():$("div.xshop-designer-image-mask-btn").show(),0==o.options.zindex?$("div.xshop-designer-image-down-btn").addClass("xepan-designer-button-disable"):$("div.xshop-designer-image-down-btn").removeClass("xepan-designer-button-disable")}),o.designer_tool.options.designer_mode?(o.designer_tool.freelancer_panel.FreeLancerComponentOptions.element.show(),o.designer_tool.freelancer_panel.setComponent($(this).data("component"))):$(".xshop-designer-tool-editing-helper.image").hide(),o.designer_tool.option_panel.fadeIn(500),o.designer_tool.current_selected_component=o,o.designer_tool.option_panel.css("z-index",70),o.designer_tool.option_panel.addClass("xshop-text-options"),top_value=parseInt($(this).offset().top)-parseInt($("#xshop-designer-image-editor").height()+10),o.designer_tool.option_panel.offset({top:top_value,left:$(this).offset().left}),o.designer_tool.options.designer_mode&&(o.editor.image_x.val(o.options.x),o.editor.image_y.val(o.options.y),o.editor.image_width.val(o.options.width),o.editor.image_height.val(o.options.height)),o.editor.setImageComponent(o),e.stopPropagation()})):this.element.show(),void 0==i&&(this.element.css("top",o.designer_tool.option2screen(o.options.y)),this.element.css("left",o.designer_tool.option2screen(o.options.x)),this.element.css("width",o.designer_tool.option2screen(o.options.width)),this.element.css("height",o.designer_tool.option2screen(o.options.height))),void 0!=this.xhr&&this.xhr.abort(),this.xhr=$.ajax({url:"?page=xepan_commerce_designer_renderimage&cut_page=1",type:"GET",data:{default_value:o.options.default_value,crop:o.options.crop,crop_x:o.options.crop_x,crop_y:o.options.crop_y,crop_height:o.options.crop_height,crop_width:o.options.crop_width,replace_image:o.options.replace_image,rotation_angle:o.options.rotation_angle,url:o.options.url,zoom:o.designer_tool.zoom,width:o.options.width,height:o.options.height,max_width:o.designer_tool.safe_zone.width()/1.5,max_height:o.designer_tool.safe_zone.height()/1.5,auto_fit:i===!0,mask:o.options.mask_options,mask_added:o.options.mask_added,apply_mask:o.options.apply_mask,is_mask_image:o.options.is_mask_image,x:o.options.x,y:o.options.y,zindex:o.options.zindex}}).done(function(e){o.options.is_mask_image?o.element.find("img[is_mask_image=1]").attr("src","data:image/png;base64, "+e):o.element.find("img[is_mask_image=0]").attr("src","data:image/png;base64, "+e),window.setTimeout(function(){o.element.height(o.element.find("img[is_mask_image=0]").height()),o.element.width(o.element.find("img[is_mask_image=0]").width())},300),i===!0&&window.setTimeout(function(){o.options.width=o.designer_tool.screen2option(o.element.find("img").width()),o.options.height=o.designer_tool.screen2option(o.element.find("img").height())},200),o.xhr=void 0}).fail(function(e){console.log("error")}).always(function(){console.log("complete")}),o.options.mask_added&&o.updateMask()}};
function sticky_relocate(){var t=$(window).scrollTop();if($(".xshop-designer-tool-topbar").length>0){var e=$(".xshop-designer-tool-topbar").offset().top;t>5?$(".xshop-designer-tool-topbar").addClass("xshop-designer-top-bar-stick"):$(".xshop-designer-tool-topbar").removeClass("xshop-designer-top-bar-stick")}}function initAligningGuidelines(t){function e(t){n(t.x+.5,t.y1>t.y2?t.y2:t.y1,t.x+.5,t.y2>t.y1?t.y2:t.y1)}function o(t){n(t.x1>t.x2?t.x2:t.x1,t.y+.5,t.x2>t.x1?t.x2:t.x1,t.y+.5)}function n(t,e,o,n){s.save(),s.lineWidth=c,s.strokeStyle=p,s.beginPath(),s.moveTo((t+l[4])*d,(e+l[5])*d),s.lineTo((o+l[4])*d,(n+l[5])*d),s.stroke(),s.restore()}function i(t,e){t=Math.round(t),e=Math.round(e);for(var o=t-r,n=t+r;n>=o;o++)if(o===e)return!0;return!1}var s=t.getSelectionContext(),a=5,r=4,c=1,p="rgb(0,255,0)",l,d=1,h=[],u=[];t.on("mouse:down",function(){l=t.viewportTransform,d=t.getZoom()}),t.on("object:moving",function(e){var o=e.target,n=t.getObjects(),s=o.getCenterPoint(),r=s.x,c=s.y,p=o.getBoundingRectHeight()/l[3],d=o.getBoundingRectWidth()/l[0],_=!1,g=!1,v=t._currentTransform;if(v){for(var f=n.length;f--;)if(n[f]!==o){var m=n[f].getCenterPoint(),b=m.x,y=m.y,w=n[f].getBoundingRectHeight()/l[3],x=n[f].getBoundingRectWidth()/l[0];i(b,r)&&(g=!0,h.push({x:b,y1:c>y?y-w/2-a:y+w/2+a,y2:c>y?c+p/2+a:c-p/2-a}),o.setPositionByOrigin(new fabric.Point(b,c),"center","center")),i(b-x/2,r-d/2)&&(g=!0,h.push({x:b-x/2,y1:c>y?y-w/2-a:y+w/2+a,y2:c>y?c+p/2+a:c-p/2-a}),o.setPositionByOrigin(new fabric.Point(b-x/2+d/2,c),"center","center")),i(b+x/2,r+d/2)&&(g=!0,h.push({x:b+x/2,y1:c>y?y-w/2-a:y+w/2+a,y2:c>y?c+p/2+a:c-p/2-a}),o.setPositionByOrigin(new fabric.Point(b+x/2-d/2,c),"center","center")),i(y,c)&&(_=!0,u.push({y:y,x1:r>b?b-x/2-a:b+x/2+a,x2:r>b?r+d/2+a:r-d/2-a}),o.setPositionByOrigin(new fabric.Point(r,y),"center","center")),i(y-w/2,c-p/2)&&(_=!0,u.push({y:y-w/2,x1:r>b?b-x/2-a:b+x/2+a,x2:r>b?r+d/2+a:r-d/2-a}),o.setPositionByOrigin(new fabric.Point(r,y-w/2+p/2),"center","center")),i(y+w/2,c+p/2)&&(_=!0,u.push({y:y+w/2,x1:r>b?b-x/2-a:b+x/2+a,x2:r>b?r+d/2+a:r-d/2-a}),o.setPositionByOrigin(new fabric.Point(r,y+w/2-p/2),"center","center"))}_||(u.length=0),g||(h.length=0)}}),t.on("before:render",function(){t.clearContext(t.contextTop)}),t.on("after:render",function(){for(var t=h.length;t--;)e(h[t]);for(var t=u.length;t--;)o(u[t]);h.length=u.length=0}),t.on("mouse:up",function(){h.length=u.length=0,t.renderAll()})}var canvas_number=2;jQuery.widget("ui.xepan_xshopdesigner",{editors:[],options:{showTopBar:!0,IncludeJS:["FreeLancerPanel"],ComponentsIncluded:["BackgroundImage","Text","Image","PDF","ZoomPlus","ZoomMinus","Save","Calendar"],design:[],show_cart:!1,cart_options:[],designer_mode:!1,width:void 0,height:void 0,selected_layouts_for_print:{},calendar_starting_month:void 0,calendar_starting_year:void 0,calendar_event:{},base_url:void 0,watermark_text:"xepan",is_start_call:!1,start_page:!1,start_layout:!1,show_tool_bar:!0,show_pagelayout_bar:!0,show_canvas:!0,printing_mode:!1},_create:function(){this.current_page="Front Page",this.current_layout="Main Layout",this.options.start_page&&(this.current_page=this.options.start_page),this.options.start_layout&&(this.current_layout=this.options.start_layout),this.pages_and_layouts={"Front Page":{"Main Layout":{components:[],background:void 0}}},this.layout_finalized={"Front Page":"Main Layout"},this.current_selected_component=void 0,this.current_selected_component_id=void 0,this.item_member_design_id=void 0,this.workplace=void 0,this.canvas=void 0,this.canvasObj=void 0,this.safe_zone=void 0,this.cart=void 0,this.zoom=1,this.delta_zoom=0,this.px_width=void 0,this.option_panel=void 0,this.freelancer_panel=void 0,this.top_bar=void 0,this.pointtopixel={6:8,7:9,8:11,9:12,10:13,11:15,12:16,13:17,14:19,15:21,16:22,17:23,18:24,19:25,20:26,21:28,22:29,23:31,24:32,25:33,26:35,27:36,28:37,29:38,30:40,31:41,32:42,33:44,34:45,35:47,36:48},this.pixeltopoint={6:8,7:9,8:11,9:12,10:13,11:15,12:16,13:17,14:19,15:21,16:22,17:23,18:24,19:25,20:26,21:28,22:29,23:31,24:32,25:33,26:35,27:36,28:37,29:38,30:40,31:41,32:42,33:44,34:45,35:47,36:48},this.font_family=["Abel","Abril Fatface","Aclonica","Acme","Actor","Cabin","Cambay","Cambo","Candal","Petit Formal Script","Petrona","Philosopher","Piedra","Ubuntu"],this.setupLayout()},setupLayout:function(){var t=this;t.options.is_start_call&&($.each(this.options.IncludeJS,function(e,o){$.atk4.includeJS(t.options.base_url+"vendor/xepan/commerce/templates/js/tool/designer/plugins/"+o+".js")}),$.each(this.options.ComponentsIncluded,function(e,o){$.atk4.includeJS(t.options.base_url+"vendor/xepan/commerce/templates/js/tool/designer/plugins/"+o+".js")}),$.atk4.includeJS(t.options.base_url+"vendor/xepan/commerce/templates/js/tool/designer/plugins/PageLayout.js")),$.atk4(function(){t.setupWorkplace(),window.setTimeout(function(){t.setupCanvas(),t.options.is_start_call&&t.options.showTopBar&&t.setupToolBar(),t.loadDesign(),t.options.is_start_call&&(t.options.show_pagelayout_bar&&t.setupPageLayoutBar(),t.setupFreelancerPanel()),t.render()},200)})},loadDesign:function(){var t=this;if(""==t.options.design||!t.options.design||"null"==t.options.design){var e=new BackgroundImage_Component;return e.init(t,t.canvas,null),void(t.pages_and_layouts[t.current_page][t.current_layout].background=e)}saved_design=JSON.parse(t.options.design),$.each(saved_design,function(e,o){t.pages_and_layouts[e]={},t.layout_finalized[e]="Main Layout",$.each(o,function(o,n){t.pages_and_layouts[e][o]={},t.pages_and_layouts[e][o].components=[],void 0!=n.components&&0!=n.components.length&&$.each(n.components,function(n,i){i=JSON.parse(i);var s=new window[i.type+"_Component"];s.init(t,t.canvas,t.editors[i.type]),s.options=i,s.options.load_design=!0,t.pages_and_layouts[e][o].components[n]=s});var i=new BackgroundImage_Component;i.init(t,t.canvas,null),void 0!=n.background&&(i.options=JSON.parse(n.background)),t.pages_and_layouts[e][o].background=i})}),""!=t.options.selected_layouts_for_print&&t.options.selected_layouts_for_print&&null!=t.options.selected_layouts_for_print&&void 0!=t.options.selected_layouts_for_print&&$.each(t.options.selected_layouts_for_print,function(e,o){t.layout_finalized[e]=o})},setupPageLayoutBar:function(){var t=this;if(t.options.is_start_call){var e=$('<div class="xshop-designer-tool-bottombar"></div>');e.appendTo(this.element),t.bottombar_wrapper=e,$.each(t.pages_and_layouts,function(o,n){pl=$('<div class="xshop-designer-pagethumbnail">').appendTo(e).width(200),t.options.printing_mode||$(pl).on("click",function(e){t.options.start_page=t.current_page=o,t.options.start_layout=t.current_layout=t.options.selected_layouts_for_print[o],t.render()}).css("float","left"),pl.xepan_xshopdesigner({width:t.options.width,height:t.options.height,trim:0,unit:t.options.unit,designer_mode:!1,design:t.options.design,show_cart:"0",start_page:o,start_layout:t.options.selected_layouts_for_print[o],printing_mode:t.options.printing_mode})}),t.options.show_pagelayout_bar||$(bottombar_wrapper).toggle(),t.options.printing_mode&&t.setupPdfExport()}},setupPdfExport:function(){self=this,$(".xshop-designer-tool-bottombar").click(function(t){$(".lower-canvas").css("border","2px solid red"),orientation="P",self.options.width>self.options.height&&(orientation="L");var e=new jsPDF(orientation,self.options.unit,[self.options.width,self.options.height],!0);$(this).find("canvas").each(function(t,o){img_data=o.toDataURL(),e.addImage(img_data,"PNG",0,0,self.options.width,self.options.height),e.addPage()}),e.save("a.pdf")})},setupToolBar:function(){var t=this;if(this.top_bar=$('<div class="xshop-designer-tool-topbar row"></div>'),this.top_bar.prependTo(this.element),t.options.show_tool_bar){var e=$('<h1 class="xshop-designer-item-name">'+t.options.item_name+"</h1>");e.prependTo(this.top_bar.parent())}var o=$('<div class="xshop-designer-tool-topbar-buttonset"></div>').appendTo(this.top_bar);this.option_panel=$('<div class="xshop-designer-tool-topbar-options" style="display:none; position:absolute;"></div>').appendTo(this.top_bar),$.each(this.options.ComponentsIncluded,function(e,o){var n=new window[o+"_Component"];n.init(t,t.canvas),tool_btn=n.renderTool(t.top_bar),t.editors[o]=n.editor}),t.options.show_tool_bar||$(t.top_bar).toggle()},setupFreelancerPanel:function(){var t=this;this.options.designer_mode&&(this.freelancer_panel=new FreeLancerPanel(this.top_bar,t,t.canvas),this.freelancer_panel.init())},setupWorkplace:function(){this.workplace=$('<div class="xshop-designer-tool-workplace" style="width:100%"></div>').appendTo(this.element)},setupComponentPanel:function(t){this.component_panel=$('<div id="xshop-designer-component-panel" class=" col-md-3">Nothing Selecetd</div>').appendTo(t)},setupCanvas:function(){var t=this;this.canvas=$('<div class="xshop-desiner-tool-canvas atk-move-center" style="position:relative; z-index:0;"><canvas id="xshop-desiner-tool-canvas'+canvas_number+'"></canvas></div>').appendTo(this.workplace),t.options.is_start_call&&!t.options.printing_mode?this.canvasObj=new fabric.Canvas("xshop-desiner-tool-canvas"+canvas_number,{selection:!1}):this.canvasObj=new fabric.StaticCanvas("xshop-desiner-tool-canvas"+canvas_number),t.options.is_start_call&&!t.options.printing_mode&&initAligningGuidelines(this.canvasObj),this.canvas.css("width",this.options.width+this.options.unit),this.px_width=this.canvas.width(),canvas_number++,t.options.printing_mode?this.canvas.css("width",3.125*this.options.width+this.options.unit):(this.canvas.css("overflow","hidden"),this.canvas.width()>this.workplace.width()&&this.canvas.css("width",this.workplace.width()-20+"px"),this.canvas.width()<this.workplace.width()/2&&this.canvas.width(this.workplace.width()/2)),this.canvasObj.on("selection:cleared",function(){$(".ui-selected").removeClass("ui-selected"),t.option_panel.hide(),t.current_selected_component=void 0,t.current_selected_component_id=void 0,t.options.designer_mode&&t.freelancer_panel.FreeLancerComponentOptions.element.hide()}),this.canvasObj.on("object:selected",function(e){t.current_selected_component_id=t.canvasObj.getObjects().indexOf(e.target),t.current_selected_component=t.canvasObj.getActiveObject().component}),this.canvasObj.on("object:scaling",function(e){var o=e.target;o.component.options.width=o.width*o.scaleX/t._getZoom(),o.component.options.height=o.height*o.scaleY/t._getZoom()}),this.canvasObj.on("object:moving",function(e){var o=t.canvasObj.item(t.current_selected_component_id),n=o.component;n.options.x=o.left/t._getZoom(),n.options.y=o.top/t._getZoom();var i=e.target;i.currentHeight>i.canvas.height||i.currentWidth>i.canvas.width||(i.setCoords(),(i.getBoundingRect().top<0||i.getBoundingRect().left<0)&&(i.top=Math.max(i.top,i.top-i.getBoundingRect().top),i.left=Math.max(i.left,i.left-i.getBoundingRect().left)),(i.getBoundingRect().top+i.getBoundingRect().height>i.canvas.height||i.getBoundingRect().left+i.getBoundingRect().width>i.canvas.width)&&(i.top=Math.min(i.top,i.canvas.height-i.getBoundingRect().height+i.top-i.getBoundingRect().top),i.left=Math.min(i.left,i.canvas.width-i.getBoundingRect().width+i.left-i.getBoundingRect().left)),t.option_panel.offset({top:t.canvasObj._offset.top+o.top-t.option_panel.height(),left:t.canvasObj._offset.left+o.left+o.width}))}),this.canvasObj.on("object:rotating",function(e){var o=t.canvasObj.item(t.current_selected_component_id),n=o.component;n.options.rotation_angle=o.angle}),t.options.show_canvas||$(t.canvas).toggle()},setupCart:function(){var t=this;t.options.show_cart&&(t.options.designer_mode||(t.options.cart_options.show_cart_btn=!0,t.options.cart_options.base_url=t.options.base_url,cart_container=$('<div class="xepan-xshop-designer-cart-container"></div>').appendTo(t.element),price_div=$('<div class="xshop-item-price"></div>').appendTo(cart_container),original_rate=$('<div class="xshop-item-old-price">'+t.options.currency_symbole+" "+t.options.item_original_price+"</div>").appendTo(price_div),price_rate=$('<div class="xshop-item-new-price">'+t.options.currency_symbole+" "+t.options.item_sale_price+"</div>").appendTo(price_div),this.cart=$('<div class="xshop-designer-item-custom-field-container"></div>').appendTo(cart_container),this.cart.xepan_xshop_addtocart(t.options.cart_options),cart_container.hide()))},render:function(){var t=this;select_object_id=t.current_selected_component_id,this.canvas.css("height",this.options.height+this.options.unit),this.canvas.height(this.canvas.height()*this._getZoom()),this.canvasObj.setWidth(this.canvas.width()),this.canvasObj.setHeight(this.canvas.height()),this.canvasObj.calcOffset(),this.canvas.find(".xshop-designer-component").hide(),this.canvasObj.clear(),this.canvasObj.setBackgroundImage("",this.canvasObj.renderAll.bind(this.canvasObj)),$.each(t.pages_and_layouts[t.current_page][t.current_layout].components,function(t,e){e.element=void 0}),t.options.is_start_call&&(this.safe_zone=new fabric.Rect({left:t._toPixel(this.options.trim),top:t._toPixel(this.options.trim),strokeWidth:1,stroke:"rgba(255,0,0,0.6)",strokeDashArray:[5,5],fill:"transparent",hasBorders:!0,hasControls:!1,selectable:!1,evented:!1,width:t._toPixel(this.options.width-2*this.options.trim),height:t._toPixel(this.options.height-2*this.options.trim),angle:0}),this.canvasObj.add(this.safe_zone)),void 0!=t.pages_and_layouts[t.current_page][t.current_layout].components&&0!=t.pages_and_layouts[t.current_page][t.current_layout].components.length&&$.each(t.pages_and_layouts[t.current_page][t.current_layout].components,function(e,o){o.render(t)}),void 0!=t.pages_and_layouts[t.current_page][t.current_layout].background&&0!=t.pages_and_layouts[t.current_page][t.current_layout].background.length&&t.pages_and_layouts[t.current_page][t.current_layout].background.render(t),select_object_id&&(t.current_selected_component_id=select_object_id,t.canvasObj.setActiveObject(t.canvasObj.item(select_object_id)))},_toPixel:function(t){return this.canvas.width()/this.options.width*t},_toUnit:function(t){return this.options.width/this.canvas.width()*t},_getZoom:function(){var t=this.canvas.width()/this.px_width;return t!=this.zoom&&(this.delta_zoom=this.zoom+t,this.zoom=t),this.zoom},_isDesignerMode:function(){return this.options.designer_mode},get_widget:function(){return this},check:function(){},screen2option:function(t){return t/this._getZoom()},option2screen:function(t){return t*this._getZoom()}}),function($){$.fn.delayKeyup=function(t,e){return $(this).keyup(function(o){var n=o.currentTarget;n.delayTimer&&clearTimeout(n.delayTimer),n.delayTimer=setTimeout(function(){t($(n))},e)}),$(this)}}(jQuery),$.ui.plugin.add("draggable","smartguides",{start:function(t,e){var n=$(this).data("ui-draggable");o=n.options,n.elements=[],$(o.smartguides.constructor!=String?o.smartguides.items||":data(ui-draggable)":o.smartguides).each(function(){var t=$(this),e=t.offset();this!=n.element[0]&&n.elements.push({item:this,width:t.outerWidth(),height:t.outerHeight(),top:e.top,left:e.left})})},drag:function(t,e){var o=$(this).data("ui-draggable"),n=o.options,i=n.tolerance;$(".guidex").css({display:"none"}),$(".guidey").css({display:"none"});var s=e.offset.left,a=s+o.helperProportions.width,r=e.offset.top,c=r+o.helperProportions.height;xc=(s+a)/2,yc=(r+c)/2;for(var p=o.elements.length-1;p>=0;p--){var l=o.elements[p].left,d=l+o.elements[p].width,h=o.elements[p].top,u=h+o.elements[p].height;hc=(l+d)/2,vc=(h+u)/2;var _=Math.abs(l-a)<=i,g=Math.abs(l-s)<=i,v=Math.abs(d-s)<=i,f=Math.abs(h-c)<=i,m=Math.abs(u-r)<=i,b=Math.abs(hc-xc)<=i,y=Math.abs(vc-yc)<=i,w=Math.abs(d-a)<=i;g&&(e.position.left=o._convertPositionTo("relative",{top:0,left:l}).left-o.margins.left,$(".guidex").css({left:l-i+4,display:"block"})),_&&(e.position.left=o._convertPositionTo("relative",{top:0,left:l-o.helperProportions.width}).left-o.margins.left,$(".guidex").css({left:l-i+4,display:"block"})),v&&(e.position.left=o._convertPositionTo("relative",{top:0,left:d}).left-o.margins.left,$(".guidex").css({left:d-i+4,display:"block"})),f&&(e.position.top=o._convertPositionTo("relative",{top:h-o.helperProportions.height,left:0}).top-o.margins.top,$(".guidey").css({top:h-i+4,display:"block"})),m&&(e.position.top=o._convertPositionTo("relative",{top:u,left:0}).top-o.margins.top,$(".guidey").css({top:u-i+4,display:"block"})),w&&(e.position.left=o._convertPositionTo("relative",{top:0,left:d-o.helperProportions.width}).left-o.margins.left,$(".guidex").css({left:d-i+4,display:"block"})),b&&(e.position.left=o._convertPositionTo("relative",{top:0,left:hc-o.helperProportions.width/2}).left-o.margins.left,$(".guidex").css({left:hc-i+4,display:"block"})),y&&(e.position.top=o._convertPositionTo("relative",{top:vc-o.helperProportions.height/2,left:0}).top-o.margins.top,$(".guidey").css({top:vc-i+8,display:"block"}))}},stop:function(t,e){$(".guidex").hide(),$(".guidey").hide()}});